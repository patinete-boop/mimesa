<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mesa DJ + Spotify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .status { margin-top: 10px; color: #555; }
    .error { color: #b00020; }
    .ok { color: #006400; }
  </style>
</head>
<body>
  <h1>Mesa DJ conectada a Spotify</h1>

  <!-- Botón de login -->
  <button id="loginBtn">Login con Spotify</button>
  <div id="status" class="status">Estado: esperando login…</div>

  <!-- Playlists -->
  <div>
    <h3>Tus playlists</h3>
    <ul id="playlists"></ul>
  </div>

  <!-- Controles básicos -->
  <div>
    <button id="playPauseBtn" disabled>Play/Pause</button>
    <button id="nextBtn" disabled>Siguiente</button>
    <button id="prevBtn" disabled>Anterior</button>
    <input id="vol" type="range" min="0" max="100" value="80">
    <label for="vol">Volumen</label>
  </div>

  <!-- SDK de Spotify -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
  // Configuración de tu app en Spotify
  const CLIENT_ID = "f0bf147de2084f78b676c0fb89482fee";
  const REDIRECT_URI = "https://patinete-boop.github.io/mimesa/callback";

  // Scopes (permisos)
  const SCOPES = [
    "streaming",
    "user-read-email",
    "user-read-private",
    "user-read-playback-state",
    "user-modify-playback-state",
    "playlist-read-private"
  ].join(" ");

  const statusEl = document.getElementById("status");

  function setStatus(msg, ok=false) {
    statusEl.textContent = "Estado: " + msg;
    statusEl.className = "status " + (ok ? "ok" : "");
  }
  function setError(msg) {
    statusEl.textContent = "Error: " + msg;
    statusEl.className = "status error";
    console.error(msg);
  }

  // Utilidad: leer token desde hash
  function getTokenFromHash() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get("access_token");
  }

  // Construir URL de login
  function getAuthURL() {
    const auth = new URL("https://accounts.spotify.com/authorize");
    auth.searchParams.set("client_id", CLIENT_ID);
    auth.searchParams.set("response_type", "token");
    auth.searchParams.set("redirect_uri", REDIRECT_URI);
    auth.searchParams.set("scope", SCOPES);
    auth.searchParams.set("show_dialog", "true");
    return auth.toString();
  }

  // Estado global
  let accessToken = null;
  let player = null;
  let deviceId = null;

  // Login
  document.getElementById("loginBtn").addEventListener("click", () => {
    window.location.href = getAuthURL();
  });

  // Post-login: si volvemos con token en el hash o desde callback.html
  window.addEventListener("load", async () => {
    accessToken = getTokenFromHash();
    if (!accessToken) {
      const savedHash = localStorage.getItem("spotify_hash");
      if (savedHash) {
        const params = new URLSearchParams(savedHash.substring(1));
        accessToken = params.get("access_token");
      }
    }
    if (!accessToken) {
      setStatus("pulsa Login con Spotify");
      return;
    }

    // Limpiar hash y marca que estamos autenticados
    history.replaceState(null, "", window.location.pathname);
    setStatus("autenticado, cargando playlists…", true);

    try {
      await loadPlaylists();
      initPlayer();
    } catch (e) {
      setError("no se pudieron cargar playlists: " + (e?.message || e));
    }
  });

  async function loadPlaylists() {
    const res = await fetch("https://api.spotify.com/v1/me/playlists", {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error("API playlists respondió " + res.status + ": " + txt);
    }
    const data = await res.json();
    const ul = document.getElementById("playlists");
    ul.innerHTML = "";

    if (!data.items || data.items.length === 0) {
      setStatus("no hay playlists disponibles", true);
      return;
    }

    data.items.forEach(pl => {
      const li = document.createElement("li");
      li.textContent = `${pl.name} (${pl.tracks.total} canciones)`;
      li.style.cursor = "pointer";
      li.addEventListener("click", () => startPlaybackWithPlaylist(pl.uri));
      ul.appendChild(li);
    });
  }

  function initPlayer() {
    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({
        name: "Mesa DJ HTML (navegador)",
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.8
      });

      // Eventos del SDK
      player.addListener("ready", async ({ device_id }) => {
        deviceId = device_id;
        console.log("Device listo con ID:", device_id);
        setStatus("dispositivo listo, transfiriendo reproducción…", true);

        // Habilitar botones
        document.getElementById("playPauseBtn").disabled = false;
        document.getElementById("nextBtn").disabled = false;
        document.getElementById("prevBtn").disabled = false;

        // Transferir playback automáticamente al navegador
        try {
          await transferPlaybackToBrowser();
          setStatus("reproducción en el navegador, selecciona una playlist o usa los controles", true);
        } catch (e) {
          setError("no se pudo transferir la reproducción: " + (e?.message || e));
        }
      });

      player.addListener("not_ready", ({ device_id }) => {
        console.warn("Device no listo", device_id);
        setStatus("dispositivo no listo, reintenta recargar la página");
      });

      player.addListener("initialization_error", ({ message }) => setError("init: " + message));
      player.addListener("authentication_error", ({ message }) => setError("auth: " + message));
      player.addListener("account_error", ({ message }) => setError("cuenta: " + message));
      player.addListener("playback_error", ({ message }) => setError("playback: " + message));

      player.connect();

      // Controles
      document.getElementById("playPauseBtn").addEventListener("click", () => player.togglePlay());
      document.getElementById("nextBtn").addEventListener("click", () => player.nextTrack());
      document.getElementById("prevBtn").addEventListener("click", () => player.previousTrack());

      document.getElementById("vol").addEventListener("input", (e) => {
        const v = Number(e.target.value) / 100;
        player.setVolume(v);
      });
    };
  }

  async function transferPlaybackToBrowser() {
    const res = await fetch("https://api.spotify.com/v1/me/player", {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ device_ids: [deviceId], play: true })
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error("API transfer respondió " + res.status + ": " + txt);
    }
  }

  async function startPlaybackWithPlaylist(playlistUri) {
    // Transferir playback al navegador si aún no lo está
    try { await transferPlaybackToBrowser(); } catch (e) { setError(e.message); }

    // Iniciar playback con la playlist
    const res = await fetch("https://api.spotify.com/v1/me/player/play?device_id=" + deviceId, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ context_uri: playlistUri })
    });
    if (!res.ok) {
      const txt = await res.text();
      setError("API play respondió " + res.status + ": " + txt);
    } else {
      setStatus("reproduciendo playlist en el navegador", true);
    }
  }
  </script>
</body>
</html>
